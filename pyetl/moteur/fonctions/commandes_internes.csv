!att_tri1;valeur_tri1;att_tri2;valeur_tri2;att_sortie;defaut;att_entree;mode;param1;param2;debug;variables;
!============================== bloc utilitaires ===========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#init_mp;;;;;;;;;;
#!help;initialise un module en mode multiprocessing (ne fait rien et attends)
;;;;;;;idle;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pass;;;;;;;;;;
#!help;placeholdermacro: s'il faut une macro qui ne fait rien(ne fait rien et passe les objets)
;;;;;;;pass;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#stdvar;;;;;;;;;;
#!help;variables de base appele par tous les autres elements
#!vars;format; format de sortie
#!vars;acces; acces base de donnees si necessaire;;;;;;;;;;
#!vars;dest; acces base de donnees en sortie si necessaire;;;;;;;;;;
$F_sortie=%format%;%F_sortie%;csv;;;;;;;;;
$mode_sortie=%mode_sortie%;D;;;;;;;;;;
K:%F_sortie%=sql;$format_schema=%F_sortie%;
$#%acces%;;;;;;;;;;;
$#%dest%;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#gid;;;;;;;;;;
#!help;ajout d un gid si necessaire;;;;;;;;;;
#!desc;le gid n est ajoute que si la classe n a pas de clef primaire;;;
;has:PK;;;;;;pass;;;fin;
|sinon:gid;;;;gid_orig;;gid;ren;;;fin;
|:;;;;gid(0:S,P);;#classe;cnt;1;1;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_std;;;;;;;;;;
#!help;ajoute les attributs standard  date_maj / date_creation;;;;;;;;;;
;;;;date_creation(D,D:I);;#_date_sys_cre;set;;;;
<#gid
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli_modif;;;;;;;;;;
#!help;ajoute les attributs standard  date_maj / date_creation et auteur ;;;;;;;;;;
<#att_sigli_std
;;;;date_maj(D,D:A);;#_date_sys_mod;set;;;fin;
;;;;auteur(T,D:A);;auteur;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#att_sigli;modif;;;;;;;;;
#!help;ajoute les attributs standard a un schema;
#!pars;modif;0/1 indique si la classe doit etre modifiee;
!;;;;;;;print;valeur de modif:%modif%;;
P:modif;;;;;;;pass;;;
|:<#att_sigli_modif;;;;;;
|sinon:<#att_sigli_std;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmin;;;;;;;;;;
#!help;passe les noms de classe et de groupe en minuscule;;
;;;;#classe;;#classe;lower;;;fin;
;;;;#groupe;;#groupe;lower;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#groupe;groupe;;;;;;;;;
#!help;force le groupe;;;;;
#!pars;groupe;nouveau groupe;;;;;;;;;;
;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#classe;classe;;;;;;;;;
#!help;force la classe;;;;
#!pars;classe;nouvelle classe;;;;;;;;;;
;;;;#classe;%classe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#ident;groupe;classe;;;;;;;;
#!help;force le groupe et la classe;;;;;
#!pars;groupe;nouveau groupe;;;;;;;;;;
#!pars;classe;nouvelle classe;;;;;;;;;;
<#groupe:%groupe%;;;;
<#classe:%classe%;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#prefix;prefix;;;;;;;;;
#!help;prefixe la classe p:prefix: prefixe a ajouter a la classe;;;;;;;;;;
;;;;+#classe;%prefix%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#rename;old;new;;;;;;;
#!help:modifie la classe p:old: partie a remplacer >new: partie de remplacement;;;;;;;;;
;;;;#classe;;#classe;sub;%old%;%new%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#regroupe;groupe;stocke_groupe;;;;;;;;
#!help;force le groupe et le transfere sur un attribut
#!pars;groupe;nom du nouveau groupe
#!pars;stocke_groupe;nom de l'attribut contenant l'ancien groupe;;;;;;;;;;
;;;;%stocke_groupe%;;#groupe;set;;;fin;
;;;;#groupe;%groupe%;;set;;;fin;
;;;;#schema;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#version;full;;;;;;;;;;
#!help;affiche la version de pyetl;;;;;;;;;;
#!api;version;text;
#!pars;full(B);version complete;
$sans_sortie;1;
;;;;;;;version;%full%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
#!help ;affectation  absolue de champs; ;;;;;;;;;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#supp;atts;;;;;;;;
#!help ;suppression de champs; ;;;;;;;;;
;;;;%atts%;;;supp;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
#!help ;passe une commande a la sauvage; ;;;;;;;;;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
#!help ;modif conditionelle de valeurs dans un champs; ;;;;;;;;;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#low;al;;;;;;;
#!help ;passe une liste d attributs en minuscule; ;;;;;;;;;
;;;;%al%;;;lower;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fanout;;;;;;;;;;
$mode_sortie=C;;;;;;;;;;;
$fanout=file;;;;;;;;;;;
$F_sortie=%format%;asc;;;;;;;;;;
!========================= lecture donnees ============================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#extractm;;;;;;;;
#!help;extraction en mode multiprocesseur;;;;;;;;;;
<#stdvar;;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;;
;;;;X;;;charge;%fich%;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract;niveau;classe;;;;;;;;
#!help;extraction de niveaux ou de classes;;;;;;;;;;
<#stdvar;;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;;
K:%multigeom%;;;;;;%multigeom%;;multigeom;;;fin;
#groupe;%niveau%;#classe;%classe%;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#extract+gid;niveau;classe;;;;;;;;;;
#!help;lecture d'un jeu de donnees d' une base avec ajout d un gid si necessaire p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
<#extract;%niveau%;%classe%;;;;;;;;;;;
<#gid;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#valide;niveau;classe;;;;;;;;
#!help;validation de niveaux ou de classes;;;;;;;;;;
<#stdvar;txt;;;;;;;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
#groupe;%niveau%;#classe;%classe%;;;;valide_schema;;;fin;10,date_creation
!===========================================================================================;;;;;;;;;;;
&&#define;#analyse;force;;;;;;;;;
#!help;analyse d'un jeu de donnees p:format force ;;;;;;;;;;
$format_schema=csv,xml,sql;;;;;;;;;;;
$max_conf=%max_conf%;40;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
!$F_sortie=#poubelle
K:force;;;;;;;#schema;supp;;;;
;;;;;;;schema>;%nom%;%max_conf%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#filtre;exp;;;;;;;;;
#!help;filtrage d un fichier texte;;;;;;;;;;
$F_entree=ligne;;;;
contenu;%exp%;;;;;#num_ligne,contenu;print;;;;
!=================================== acces bases de donnees ================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbaccess;acces;base;serveur;type;user;pass;;;;
#!help;positionne des elements d'acces a une base de donnees en direct;;;;;;;;;;
$base_%acces%=%base%;;;;;;;;;;;
$server_%acces%=%serveur%;;;;;;;;;;;
$db_%acces%=%type%;;;;;;;;;;;
$sitedef_%acces%='ok';;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#initdb;acces;nomfich;;;;;;;
#!help;positionne des elements d'acces a une base de donnees;;;;;;;;;;
$F_sortie=%format%;%F_sortie%;csv;;;;;;;;;
$format_schema=%format_schema%;csv,xml;;;;;;;;;;
$nom=%nomfich%;%acces%;extraction;;;;;;;;;
$xmlheader=%xmlheader%;;;;;;;;;;;
$xmlalias=%alias%;;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
!$#%acces%;%acces%;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbschema;acces;niveau;classe;nom;;;;;;
#!help;analyse une base de donnees;;;;;;;;;;
!#!desc;parametres: acces : code de la base, niveau, classe : restriction de lecture nom: nom du schema
!#!desc;variables: etendue: mode de sortie, mod: modifieur de selection
#!api;dbschema;xml;no_in
#!pars;acces;base a analyser;
#!pars;niveau;schema a analyser (exp reg);
#!pars;classe;classe a analyser (exp reg);
#!pars;nom;nom du fichier de sortie (exp reg);
#!vars;mod;selection (V T M =)
<#initdb;%acces%;%nom%;;;;
$force_schema=%etendue%;dbschema;;;;;;;;;;;
db:%acces%;%niveau%;%classe%;;;%nom%;#nombase;dbschema;%mod%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fileschema;acces;;;;;;
db:%acces%;;;;;;;dbschema;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbclean;acces;niveau;classe;nom;;;;;;
#!help;cree un script de reset de la base de donnees;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
db:%acces%;%niveau%;%classe%;;;;;dbclean;T,=;%nom%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract;acces;niveau;classe;attribut;valeur;ordre;;;;
#!help;extraction d'un jeu de donnees d'une base de donnÃ©es;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
K:%schema%;;;;;schema_entree;;;lire_schema;%schema%;csv;fin;
K:%dest%;;;;;;;;pass;;;fin;
!K:%dest%;db:%base#dest%;;;;schema_sortie;;;dbschema;;;fin;
db:%acces%;%niveau%;%classe%;%attribut%;;%valeur%;;dbalpha;%mod%;%ordre%;;
!;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbdump;acces;niveau;classe;rep_sortie;log;;;
#!help;extraction d'un jeu de donnees d'une base de donnees avec un programme externe;;;;;;;;;;
<#stdvar;;;;;;;;
db:%acces%;%niveau%;%classe%;;;;;dbextdump;%rep_sortie%;%log%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#geoextract;acces;niveau;classe;mode_geo;buffer;;;;;
#!help;extraction d'un jeu de donnees d' une base par emprise p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
$mode_sortie=D;;;;;;;;;;;
<#initdb;%acces%;;;;;
$mode_geo=dans_emprise;;;;;;;;;;;
$#%dest%;dest;;;;;;;;;;
db:%acces%;%niveau%;%classe%;dans_emprise;;buffer;;dbgeo;%mod%;%ordre%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbextract+gid;acces;niveau;classe;attribut;valeur;;;;;
#!help;lecture d'un jeu de donnees d' une base avec ajout d un gid si necessaire p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
<#dbextract;%acces%;%niveau%;%classe%;%attribut%;%valeur%;;;;;;
<#gid;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dbrequest;acces;requete;niveau;classe;;;;
#!help;recuperation d'un jeu de donnees par requete directe;;;;;;;;;;
<#initdb;%acces%;%nom%;;;;
db:%acces%;%niveau%;%classe%;;;;;dbreq;%requete%;%nom%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#dblist;acces;requete;;;;
#!help;recuperation d'un jeu de donnees par requete directe dans une variable;;;;;;;;;;
db:%acces%;;;;P:result;;;dbreq;%requete%;;;;
;;;;;;;printv;result;;;
!========================= conversion ======================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#to_sigli;;;;;;;;;;
#!help;preparation d'un jeu de donnees formatage standard sigli p:format parametres serveur base chaine_connection niveau classe;;;;;;;;;;
$format=sql;;;;;;;;;;;
<#extract+gid;;;;;;;;;;;
<#att_sigli_std;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ora2pg;;;;;;;;;;
#!help;passage de oracle vers postgis;;;;;;;;;;
$codec_sortie=utf-8;;;;;;;;;;;
$F_sortie=sql:sigli;;;;;;;;;;;
<#dbextract+gid;;;;;;;;;;;
<#cmin;;;;;;;;;;;
p:groupe;;;;#groupe;%groupe%;;set;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#sigli2elyx;;;;;;;;;;
#!help;passage de sigli vers elyx : sortie asc suppression GID renommage attributs modifies;;;;;;;;;;
$codec_sortie=cp1252;;;;;;;;;;;
<#dbextract;;;;;;;;;;;
$F_sortie=asc;;;;;;;;;;;
type_entite;;;;type;;type_entite;ren;;;fin;
gid;;;;#gid;;gid;set;;;fin;
+:;;;;;;gid;supp;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#reproj;orig;dest;grille;;;;;;;
#!help;convertit des coordonees du systeme orig vers dest;;;;;;;;;;
;;;;;%orig%;;reproj;%dest%;%grille%;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#g2p;lon;lat;;;;;;;;
#!help;convertit des coordonees lat long en attribut en point cc48;;;;;;;;;;
;;;;;0;%lon%,%lat%;setpoint;;;fin;
;;;;;LL;;reproj;CC48;NG;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cus2cc48;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;L1;;reproj;CC48;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cc2cus;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;CC48;;reproj;L1;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#ll2cus;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;LL;;reproj;CC48;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#cc482ll;;;;;;;;;;
#!help;reprojette des donnees cus en rgf93;;;;;;;;;;
;;;;;CC48;;reproj;LL;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#2p;x;y;srid;;;;;;;
#!help;convertit des coordonees x,y en attribut en point;;;;;;;;;;
;;;;;0;%x%,%y%;setpoint;%srid%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#2d;;;;;;;;;
#!help;convertit des coordonees 2d;;;;;;;;;;
;;;;;;;geom2D;;;fin;
!============================ manipulation schemas =========================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fusion_schema;nom;;;;;;;;;
#!help;fusion de schemas issus de traitements paralleles p:schema: racine des schemas a lire (*) lecture multiple >nom: nom du schema a creer;;;;;;;;;;
$format_schema=csv,xml;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=%nom%;fusion;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#schema_sigli;nom_schema=#schemas;;;;;;;;;
#!help;ajoute les attributs standard a un schema
;;;;;;;start;%nom_schema%;;fin
<#att_sigli_modif;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cree_sql;nom;dialecte;;;;;;;
#!help;conversion de schemas en sql;
#!desc;schema: racine des schemas a lire (*) lecture multiple;
#!pars;nom: nom du schema a creer;;;;;;;;;;
#!pars;dialecte: type de sql a creer;;;;;
$sans_entree=True;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$dialecte=%dialecte%;sigli;;;;;;;;;;
$nom=%nom%;donnees;;;;;;;;;;
$codec_entree=%codec_csv%;;;;;
$format_schema=sql:%dialecte%,csv;;;;;;;;;;;
!;;;;;;;start;;;;
!;;;;;;;reel;;;;
;;;;#schema;;;lire_schema;%nom%;csv;;
<#att_sigli;%modif%
!===========================================================================================;;;;;;;;;;;
&&#define;#cree_schema;nom;dialecte;modif;;;;;;
#!help;conversion de fichiers de structure en schema sql;
#!pars;nom;racine des fichiers de structure;
#!pars;dialecte;type de sql a creer;;;;;
#!pars;modif; 0/1 indique si la classe doit etre modifiee;;;;;
$nom=%nom%;schema;;;;
$dialecte=%dialecte%;sigli;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$format_schema=sql:%dialecte%,csv;;;;;;;
$enums=%enums%;enumerations;;;;
$schemas_a_sortir=%nom%
;;;;;%nom%;;cree_schema>;[#classe];%enums%;
<#att_sigli;%modif%
!============================= manipulation des parametres =================================;;;;;;;;;;fin;
!===========================================================================================;;;;;;;;;;fin;
&&#define;#site_params;key;;;;;;;;fin;
#!help;affichage des parametres de connection stockes;;;;;;;;;fin;
$sans_sortie=True;;;;;;;;;;fin;
$_entree=%_paramdir%\site_params.csv;;;;;;;;;;fin;
$force_schema=0;;;;;;;;;;fin;
$clef_crypt=%key%;rien;;;;
;;;;;;;pass;;;;
clef;&&#set;;;groupe;;valeur;set;;;;
+:;;;;;;groupe;print>;---------;noms;fin;
clef;^passwd;p:printpv;!force;valeur;******;;set;;;fin;
clef;\*\*passwd;p:key;;valeur;;valeur;decrypt;%clef_crypt%;;fin;
|:;;;;clef;passwd;;set;;;
clef;!:null;;;;;clef,valeur;print>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pwcrypt;clef;;;;;;;;;
#!help;crypte les mots de passe;;;;;;;;;;
!$_entree=%_paramdir%\site_params.csv;;;;;;;;;;;
!$_sortie=%_paramdir%;;;;;;;;;;;
$F_sortie=csv;;;;;;;;;;;
$mode_sortie=A;;;;;;;;
$separ_csv_out=#std;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
$key=%clef%;%masterkey%;;;;;;;
;;;;#classe;site_params_c;;set;;;;
clef;^passwd;;;valeur;;valeur;crypt;%key%;;;
+:;;;;+clef;**;;set;;;fin;
clef;masterkey;;;valeur;;valeur;crypt;;;;cryptolevel=0
!clef;!'';;;;;clef,valeur;print;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#mastercrypt;val;;
#!help crypte un element avec la masterkey
$sans_entree=1;;;
;;;;;;;start;;;;
;;;;v2;%val%;X;crypt;%masterkey%;;;
;;;;;;v2;print;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#print;;;;;;;;;;
;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#printparams;;;;;;;;;;
#!help;affichage;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;;;*;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#printvar;var;;;;;;;;;
#!help;affichage variable;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$force_schema=0;;;;;;;;;;;
;;;;%var%;%%var%%;;set;;;
;;;;;%var%;;print>;#classe;noms;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#pyetl_init_db;;;;;
#!help;initialise le schema pyetl pour travailler en base de donnees;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$format_schema=sql,csv;;;;;;;;;;;
$force_schema=fusion;;;;;;;;;;;
$nom=pyetl;;;;;;;;;;;
$schema=%_progdir%\moteur\db_struct\pyetl;;;;;;;;;;;
;;;;#schema;%nom%;;lire_schema;%schema%;csv;fin;
!========================================mode batch===================================================;;;;;;;;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_list_batch;bdef;sortie;;;;;;;
#!help;liste des batchs definis en base ;;;;;;;;;;
$mode_sortie=A;;;;;;;;;;;
$F_sortie=%sortie%;#print;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$sortie=%sortie%;#print;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
$ordrebatch=ordre,famille;;;;;;;;;;;
K:%sortie%;$sans_sortie=True
<#dbextract;%batchserver%;%batchschema%;%batchtable%;;;%ordrebatch%;;;;;
is:valid_date;[jours];;;;;;pass-;
p:sortie;#print;;;;;;tmpstore;;;;
+:;;;;;;nom,famille,ordre,commentaire,actif;print>;;;;
!;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch;nom_batch;famille_batch;force;;;;;;;
#!help;passe les batchs actifs;;;;;;;;;;
<#db_list_batch;;csv;;;;;;;;;
P:nom_batch;;;;;;;pass;;;;
+:nom;!%nom_batch%;;;;;;pass>;;;;
P:famille_batch;;;;;;;pass;;;;
+:famille;!%famille_batch%;;;;;;pass>;;;;
P:force;;;;;;;pass;;;;
+sinon:is:valid_date;[jours];;;;;;pass-;
|:actif;true;;;;;;pass-;
;;;;succes;;;batch;;;;
;;;;;;;pass>;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#timeselect;var;;;;;;;;;
#!help;determine si un batch est executable en fonction de l'heure;;;;;;;;;;
;;;;#_timeselect;0;;set;
is:valid_time;[%var%];;;#_timeselect;1;;set;
!===========================================================================================;;;;;;;;;;;
&&#define;#batch_rt;;;;;;;;;;
!#help;lancement de scripts en boucle depuis un fichier de jobs (mode temps reel);;;;;;;;;;;
actif;1;;;succes;;;batch;boucle;#timeselect:intervalle;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch_rt;bdef;;;;;;;;;
#!help;lance le scheduler sur une liste de taches en base lecture unique;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
<#dbextract;%batchserver%;%batchschema%;%batchscheduler%;;;;;;;;
actif;true;;;succes;;;batch;boucle;#timeselect:intervalle;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#db_batch_suivi;bdef;;;;;;;;;
#!help;lance le scheduler sur une liste de taches modifiables en base;;;;;;;;;;
$bdef=%bdef%;batchmode;;;;;;;;;;
$#%bdef%;;;;;;;;;;;
;;;;succes;#dbextract:%batchserver%:%batchschema%:%batchscheduler%;;batch;boucle;#timeselect:intervalle;;;
actif;true;is:valid_time;[intervalle];succes;;;batch;;;debug;multi=4;
!===========================================================================================;;;;;;;;;;;
&&#define;#scriptodb;nom;dest;;;;;;;;
#!help;charge un script en base;;;;;;;;;;
$#dest;;;;;;
<#extract:%nom%

!===========================================================================================;;;;;;;;;;;
&&#define;#runsql;nom;dest;;;;;;;;
#!help;lancement script_sql;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
!$#%dest%;;;;;;;;;;;
db:%dest%;;;;;%nom%;;runsql;%log%;%sortie%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#runproc;nom;dest;params;;;;;;;
#!help;lancement fonction_sql;;;;;;;;;;
$sans_sortie=True;;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$#%dest%;;;;;;;;;;;
db:%dest%;;;;;%params%;;runproc;%nom%;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#autoload;dest;;;;;;;;;
#!help;charge les derniers resultats en base de donnees;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
$#%dest%;%dest%;;;;;;;;;;
db:%dest%;;;;;%derniere_sortie%;;runsql;%log%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#zip;source;destination;;;;;;;;
#!help;zippe les resultats;;;;;;;;;;
$sans_entree=True;;;;;;;;;;;
;;;;;%_sortie%/%source%;;archive;%_sortie%/%destination%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#filter;champ;filtre;;;;;;;;
#!help;mange tous les objets qui ne satisfont pas la condition ;;;;;;;;;;
!;;;;;;;pass;;;;
%champ%;%filtre%;;;;;;pass-;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#set;atts;vals;defaut;;;;;;;
#!help ;affectation  absolue de champs; ;;;;;;;;;
;;;;%atts%;%defaut%;%vals%;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#cmd;cmd;v1;v2;v3;v4;v5;;;;
#!help ;passe une commande a la sauvage; ;;;;;;;;;
;;;;%v1%;%v2%;%v3%;%cmd%;%v4%;%v5%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#mod;att;val;repl;;;;;;;
#!help ;modif conditionelle de valeurs dans un champs; ;;;;;;;;;
%att%;%val%;;;%att%;%repl%;;set;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#indb;acces;;;;;;;;;
#!help;precharge des donnees depuis une base pour comparaison;;;;;;;;;;
db:%acces%;[#niveau];[#classe];;;;;dbalpha;=;;fin;
;;;;;P:#pk;;sortir;#store;nom;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#bdiff;acces;;;;;;;;;
#!help;sort un objet s il n existe pas en base;;;;;;;;;;
[#niveau];;[#classe];;cmp;P:#pk;;preload;#indb:acces;;fin;
P:#pk;!in:#cmp;;;;;;pass>;;;fin;
!===========================================================================================;;;;;;;;;;;
&&#define;#grid;x_orig;y_orig;pas;cases;;;;;;
#!help;repartit les objets selon une grille;;;;;;;;;;
;;;;%case%_x;;;gridx;%x_orig%;%pas%;;
;;;;%case%_y;;;gridy;%y_orig%;%pas%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#upload;fich;dest;destdir=.;;;;
#!help;charge des elements par ftp;;;;;;;;;;
$#ftp_%dest%;;;;;;
$sans_entree=1;;
$fichier=%fich%;%derniere_sortie%;;
;;;;;%fichier%;;ftp_upload;ftp_%dest%;%destdir%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#ftpdownload;fich;acces;accdir=.;;;;
#!help;charge des elements par ftp;;;;;;;;;;
$#ftp_%acces%;;;;;;
;;;;;%fich%;;ftp_download;ftp_%acces%;%accdir%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#httpdownload;url;dest;rep;;;;
#!help;charge des elements par ftp;;;;;;;;;;
;;;;;%url%;;download;%rep%;%dest%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geocode;adresse;filtres;;;;
#!help;geocode des elements;commande;parametres;;;;;;;;
"$separ_csv_out=\;";;;
$mode_sortie=D;;;;
;;;;;;%adresse%;geocode;%prefix%;%filtres%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#geocode2cus;adresse;filtres;;;;
#!help;geocode des elements et sort des points en cc48 cus;commande;parametres;;;;;;;;
"$separ_csv_out=\;";;;
;;;;;;%adresse%;geocode;%prefix%;%filtres%;;
<#g2p;latitude;longitude;
!===========================================================================================;;;;;;;;;;;
&&#define;#run;prog;params;;;;
#!help;execute une commande externe;commande;parametres;;;;;;;;
;;;;;;;run;%prog%;%params%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#editparams;perso;;;;;
$fich=%_paramdir%;;
K:perso;$fich=%_paramperso%;;
;;;;;^;;run;notepad %fich%\site_params.csv;;debug;
!===========================================================================================;;;;;;;;;;;
&&#define;#debug;;;;;;
;;;;;;;pass;;;print;
!===========================================================================================;;;;;;;;;;;
&&#define;#log;message;level;;;;
;;;;;;;log;%message%;%level%;;
!===========================================================================================;;;;;;;;;;;
&&#define;#sleep;duree;;;;;
;;;;;%duree%;;sleep;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#aduser;nom;clef;;;;
#!help;recupere un nom d utilisateur sur active directory ou LDAP;
#!pars;nom;nom de l utilisateur;
#!pars;clef;;
K:ADserver;$#%ADserver%;
;;;;P:x;%nom%;;adquery;user;%clef%;;
;;;;;%x%;;print;;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#moi;;;;;
K:ADserver;$#%ADserver%;
;;;;P:_username;%_login%;;adquery;user;;
!===========================================================================================;;;;;;;;;;;
&&#define;#test;n1;n2;a;;;;
#!help;test des variables;;;
$#%a%;
$test_v1=%n1%;;;;;
$test_v2=%n2%;;;;;
;;;;;;;printv>;%test_v1%;;;
!===========================================================================================;;;;;;;;;;;
&&#define;#fakelist;valeur;n;;;
#!help;genere une liste d'items numerotes pour les tests;
#!pars;valeur;texte a reproduire
#!pars;n;nombre de lignes
#!api;fakelist;json;
;;;;xx;%n1%;;creobj;tmp;%n2%;;
;;;;xx+;;#gid;set;;;
;;;;;;xx;print>;;;
